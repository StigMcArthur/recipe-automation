<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Automation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8e0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 16px;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 28px;
            color: #1f2937;
        }
        
        .current-day {
            color: #6b7280;
            font-size: 14px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .nav-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: #6b7280;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .nav-tab:hover {
            background: #f3f4f6;
        }
        
        .nav-tab.active {
            background: #ea580c;
            color: white;
        }
        
        .recipe-card {
            border: 2px solid #fed7aa;
            border-radius: 12px;
            padding: 20px;
            background: #fff7ed;
            margin-bottom: 16px;
        }
        
        .recipe-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .recipe-subtitle {
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .recipe-link-box {
            background: #fff;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .recipe-link-box a {
            color: #ea580c;
            text-decoration: none;
            word-break: break-all;
        }
        
        .recipe-link-box a:hover {
            text-decoration: underline;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #ea580c;
            color: white;
        }
        
        .btn-primary:hover {
            background: #c2410c;
        }
        
        .btn-success {
            background: #16a34a;
            color: white;
        }
        
        .btn-success:hover {
            background: #15803d;
        }
        
        .week-item {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        
        .week-item:hover {
            border-color: #d1d5db;
        }
        
        .week-item.today {
            border-color: #fb923c;
            background: #fff7ed;
        }
        
        .week-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }
        
        .day-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .today-badge {
            display: inline-block;
            background: #ea580c;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .meal-name {
            font-size: 18px;
            font-weight: 500;
            color: #374151;
            margin: 8px 0;
        }
        
        .recipe-type {
            font-size: 14px;
            color: #6b7280;
        }
        
        .shopping-list {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
        }
        
        .shopping-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }
        
        .shopping-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .info-box {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Content will be injected here -->
    </div>

    <script>
        // Configuration - REPLACE THESE WITH YOUR OWN VALUES
        const SHEET_ID = '1b8VXiTPe4jMVBXLKdhSYLjas36QT0tfu3OBlMrdF_Q0';
        const API_KEY = 'AIzaSyBtIH1g9yZdjJ3lOtl7o7PmA9ukc76aTtE';
        const BRIDGE_URL = 'http://localhost:5000'; // Python bridge server
        
        // Demo data (fallback)
        const DEMO_MENU = [
            { day: 'Monday', meal: 'Spaghetti Carbonara', url: 'https://www.example.com/carbonara', type: 'written' },
            { day: 'Tuesday', meal: 'Chicken Stir Fry', url: 'https://youtube.com/watch?v=abc123', type: 'video' },
            { day: 'Wednesday', meal: 'Beef Tacos', url: 'https://www.example.com/tacos', type: 'written' },
            { day: 'Thursday', meal: 'Salmon with Rice', url: 'https://www.example.com/salmon', type: 'written' },
            { day: 'Friday', meal: 'Pizza Night', url: 'https://www.example.com/pizza', type: 'written' },
            { day: 'Saturday', meal: 'BBQ Ribs', url: 'https://youtube.com/watch?v=xyz789', type: 'video' },
            { day: 'Sunday', meal: 'Roast Chicken', url: 'https://www.example.com/roast', type: 'written' }
        ];
        
        const DEMO_SHOPPING = [
            'Spaghetti - 1 lb',
            'Eggs - 6',
            'Bacon - 8 oz',
            'Parmesan cheese - 1 cup',
            'Chicken breast - 2 lbs',
            'Mixed vegetables - 1 bag',
            'Soy sauce - 1/4 cup'
        ];
        
        // State
        let currentView = 'today';
        let weeklyMenu = [];
        let shoppingList = [];
        let recipeCache = {}; // Cache for full recipes
        let isConfigured = true; // Set to true to always try loading from sheet
        
        // Get current day
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        let currentDay = days[new Date().getDay()];
        
        // Check URL parameters for day override (useful for NFC)
        const urlParams = new URLSearchParams(window.location.search);
        const dayParam = urlParams.get('day');
        if (dayParam) {
            currentDay = dayParam;
        }
        
        // Initialize
        function init() {
            loadData();
        }
        
        // Load data from Google Sheets
        function loadData() {
            loadFromGoogleSheets();
        }
        
        async function loadFromGoogleSheets() {
            const range = 'Weekly Menu!A2:E8'; // Now including column E
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                if (data.values) {
                    weeklyMenu = data.values.map((row, index) => ({
                        day: row[0] || '',
                        meal: row[1] || '',
                        url: row[2] || '',
                        type: row[3] || 'written',
                        ingredients: row[4] || '', // Existing ingredients
                        rowIndex: index + 2 // Sheet row number (A2 = index 2)
                    })).filter(item => item.day && item.meal); // Filter out empty rows
                    
                    console.log('Loaded menu:', weeklyMenu);
                    
                    // Check if any recipes need ingredient extraction
                    const needsExtraction = weeklyMenu.filter(item => !item.ingredients && item.url);
                    if (needsExtraction.length > 0) {
                        console.log(`Found ${needsExtraction.length} recipes without ingredients. Extracting...`);
                        await extractAllIngredients();
                    }
                    
                    // Load shopping list from Ingredients column
                    await loadShoppingListFromMenu();
                } else {
                    throw new Error('No data found in sheet');
                }
                
                render();
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                alert('Could not load recipes from Google Sheets. Using demo data.\n\nError: ' + error.message);
                // Fallback to demo data
                weeklyMenu = DEMO_MENU;
                shoppingList = DEMO_SHOPPING;
                render();
            }
        }
        
        async function extractAllIngredients() {
            for (const recipe of weeklyMenu) {
                if (!recipe.ingredients && recipe.url) {
                    try {
                        console.log(`Extracting ingredients for ${recipe.meal}...`);
                        const ingredients = await extractIngredientsFromUrl(recipe.url, recipe.type);
                        if (ingredients && ingredients.length > 0) {
                            recipe.ingredients = ingredients.join(', ');
                            // Update the sheet with extracted ingredients
                            await updateSheetIngredients(recipe.rowIndex, recipe.ingredients);
                            console.log(`✓ Extracted ${ingredients.length} ingredients for ${recipe.meal}`);
                        }
                    } catch (error) {
                        console.error(`Failed to extract ingredients for ${recipe.meal}:`, error);
                    }
                }
            }
        }
        
        async function extractIngredientsFromUrl(url, type) {
            // For video recipes, use cooking.guru's parsed content
            if (type === 'video') {
                const guruUrl = `https://cooking.guru/?url=${encodeURIComponent(url)}`;
                return await extractIngredientsFromPage(guruUrl);
            }
            
            // For written recipes, use bridge
            return await extractIngredientsFromPage(url);
        }
        
        async function extractIngredientsFromPage(url) {
            try {
                // Use Python bridge to fetch and parse with Ollama
                const response = await fetch(`${BRIDGE_URL}/extract-ingredients?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data.ingredients || [];
            } catch (error) {
                console.error('Error extracting ingredients:', error);
                return [];
            }
        }
        
        async function fetchFullRecipeWithOllama(url) {
            try {
                const response = await fetch(`${BRIDGE_URL}/fetch-recipe?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data.recipe;
                
            } catch (error) {
                console.error('Error fetching full recipe:', error);
                return null;
            }
        }
        
        async function updateSheetIngredients(rowIndex, ingredients) {
            const range = `Weekly Menu!E${rowIndex}`;
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?valueInputOption=RAW&key=${API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        values: [[ingredients]]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update sheet');
                }
                
                console.log(`✓ Updated row ${rowIndex} with ingredients`);
            } catch (error) {
                console.error('Error updating sheet:', error);
                // Note: This will fail with API key auth - needs OAuth
            }
        }
        
        async function loadShoppingListFromSheet() {
            // Use ingredients from weeklyMenu instead of fetching separately
            await loadShoppingListFromMenu();
        }
        
        async function loadShoppingListFromMenu() {
            try {
                // Flatten and combine all ingredients from the menu
                const allIngredients = new Set();
                weeklyMenu.forEach(recipe => {
                    if (recipe.ingredients) {
                        // Split by comma and trim each ingredient
                        recipe.ingredients.split(',').forEach(ing => {
                            const trimmed = ing.trim();
                            if (trimmed) allIngredients.add(trimmed);
                        });
                    }
                });
                
                shoppingList = Array.from(allIngredients).sort();
                console.log('Generated shopping list:', shoppingList);
                
                if (shoppingList.length === 0) {
                    shoppingList = DEMO_SHOPPING;
                }
            } catch (error) {
                console.error('Error loading shopping list:', error);
                shoppingList = DEMO_SHOPPING;
            }
        }
        
        // Convert video URLs to cooking.guru
        function convertToRecipeUrl(url, type) {
            if (type === 'video') {
                return `https://cooking.guru/?url=${encodeURIComponent(url)}`;
            }
            return url;
        }
        
        // Get today's recipe
        function getTodaysRecipe() {
            return weeklyMenu.find(item => item.day === currentDay);
        }
        
        // Render functions
        function renderTodayView() {
            const recipe = getTodaysRecipe();
            if (!recipe) {
                return `<div class="info-box">No recipe scheduled for ${currentDay}. Check your Google Sheet or view This Week tab.</div>`;
            }
            
            const recipeUrl = convertToRecipeUrl(recipe.url, recipe.type);
            const isVideo = recipe.type === 'video';
            const cacheKey = recipe.url;
            
            // Check if we have cached recipe
            const hasFullRecipe = recipeCache[cacheKey];
            
            return `
                <div class="recipe-card">
                    <h2 class="recipe-title">${recipe.meal}</h2>
                    <p class="recipe-subtitle">${recipe.day}'s Dinner</p>
                    
                    ${hasFullRecipe ? `
                        <div style="background: white; padding: 16px; border-radius: 8px; margin: 16px 0;">
                            <div style="white-space: pre-wrap; line-height: 1.6;">${hasFullRecipe}</div>
                        </div>
                    ` : `
                        <div class="recipe-link-box">
                            <strong>Recipe Link:</strong><br>
                            <a href="${recipeUrl}" target="_blank" rel="noopener noreferrer">
                                ${isVideo ? 'View on cooking.guru' : 'Open Recipe'}
                            </a>
                        </div>
                        
                        ${isVideo ? `
                            <div class="info-box">
                                📹 This is a video recipe. The link will open cooking.guru which converts it to written format.
                            </div>
                        ` : ''}
                        
                        <button class="btn btn-primary" onclick="loadFullRecipe('${cacheKey}')" style="margin-bottom: 8px;">
                            📖 Load Full Recipe with Ollama
                        </button>
                    `}
                    
                    <button class="btn btn-primary" onclick="window.open('${recipeUrl}', '_blank')" style="background: #16a34a;">
                        🔗 Open Original Recipe
                    </button>
                </div>
            `;
        }
        
        function renderWeekView() {
            if (weeklyMenu.length === 0) {
                return '<div class="info-box">No recipes loaded. Check your Google Sheet configuration.</div>';
            }
            
            const items = weeklyMenu.map((item, index) => {
                const isToday = item.day === currentDay;
                const recipeUrl = convertToRecipeUrl(item.url, item.type);
                const hasIngredients = item.ingredients && item.ingredients.length > 0;
                
                return `
                    <div class="week-item ${isToday ? 'today' : ''}">
                        <div class="week-item-header">
                            <div style="flex: 1;">
                                <div class="day-name">
                                    ${item.day}
                                    ${isToday ? '<span class="today-badge">Today</span>' : ''}
                                </div>
                                <div class="meal-name">${item.meal}</div>
                                <div class="recipe-type">
                                    ${item.type === 'video' ? '📹 Video Recipe' : '📄 Written Recipe'}
                                    ${hasIngredients ? ' • ✅ Ingredients loaded' : ' • ⚠️ No ingredients'}
                                </div>
                                ${!hasIngredients ? `
                                    <button 
                                        onclick="extractSingleRecipe(${index})" 
                                        class="btn btn-primary" 
                                        style="margin-top: 8px; padding: 6px 12px; font-size: 12px; width: auto;"
                                    >
                                        Extract Ingredients
                                    </button>
                                ` : ''}
                            </div>
                            <a href="${recipeUrl}" target="_blank" rel="noopener noreferrer" style="color: #ea580c; text-decoration: none; font-size: 24px;">
                                🔗
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
                    <h2 style="font-size: 24px; font-weight: bold; color: #1f2937;">This Week's Menu</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="extractAllMissing()" style="width: auto; padding: 10px 20px; background: #f59e0b;">
                            🔄 Extract All Ingredients
                        </button>
                        <button class="btn btn-success" onclick="showShopping()" style="width: auto; padding: 10px 20px;">
                            🛒 Shopping List
                        </button>
                    </div>
                </div>
                <div class="info-box" style="font-size: 14px;">
                    <strong>Note:</strong> Automatic ingredient extraction may not work for all websites due to CORS restrictions. 
                    If extraction fails, you'll need to manually add ingredients to your Google Sheet in column E.
                </div>
                ${items}
            `;
        }
        
        function renderShoppingView() {
            if (shoppingList.length === 0) {
                return '<div class="info-box">No ingredients found. Add an "Ingredients" column (E) to your Google Sheet with comma-separated ingredients.</div>';
            }
            
            const items = shoppingList.map((item, index) => `
                <div class="shopping-item">
                    <input type="checkbox" id="item-${index}">
                    <label for="item-${index}" style="margin: 0; cursor: pointer;">${item}</label>
                </div>
            `).join('');
            
            return `
                <h2 style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 16px;">Shopping List</h2>
                <p style="color: #6b7280; margin-bottom: 16px;">Ingredients for this week's meals:</p>
                
                <div class="shopping-list">
                    ${items}
                </div>
                
                <button class="btn btn-primary" onclick="copyShoppingList()" style="margin-top: 16px;">
                    Copy to Clipboard
                </button>
            `;
        }
        
        function renderDictionaryView() {
            return `
                <h2 style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 16px;">Saved Recipes</h2>
                <p style="color: #6b7280; margin-bottom: 16px;">Your recipe collection for future weeks.</p>
                
                <div class="info-box">
                    📚 Recipe dictionary will be populated from your Google Sheet's "Recipe Dictionary" tab. 
                    You can save frequently used recipes here for easy access when planning future weeks.
                </div>
            `;
        }
        
        function render() {
            const app = document.getElementById('app');
            
            let content = `
                <div class="card">
                    <div class="header">
                        <div>
                            <h1>🍳 Recipe Automation</h1>
                            <div class="current-day">${currentDay}</div>
                        </div>
                    </div>
                </div>
                
                <div class="nav-tabs">
                    <button class="nav-tab ${currentView === 'today' ? 'active' : ''}" onclick="changeView('today')">
                        Today's Recipe
                    </button>
                    <button class="nav-tab ${currentView === 'week' ? 'active' : ''}" onclick="changeView('week')">
                        This Week
                    </button>
                    <button class="nav-tab ${currentView === 'dictionary' ? 'active' : ''}" onclick="changeView('dictionary')">
                        Saved Recipes
                    </button>
                </div>
                
                <div class="card">
            `;
            
            switch(currentView) {
                case 'today':
                    content += renderTodayView();
                    break;
                case 'week':
                    content += renderWeekView();
                    break;
                case 'shopping':
                    content += renderShoppingView();
                    break;
                case 'dictionary':
                    content += renderDictionaryView();
                    break;
            }
            
            content += '</div>';
            
            app.innerHTML = content;
        }
        
        // Event handlers
        function changeView(view) {
            currentView = view;
            render();
        }
        
        function showShopping() {
            currentView = 'shopping';
            render();
        }
        
        async function extractSingleRecipe(index) {
            const recipe = weeklyMenu[index];
            if (!recipe || !recipe.url) return;
            
            const btn = event.target;
            btn.textContent = 'Extracting...';
            btn.disabled = true;
            
            try {
                const ingredients = await extractIngredientsFromUrl(recipe.url, recipe.type);
                if (ingredients && ingredients.length > 0) {
                    recipe.ingredients = ingredients.join(', ');
                    await updateSheetIngredients(recipe.rowIndex, recipe.ingredients);
                    await loadShoppingListFromMenu();
                    render();
                    alert(`✓ Extracted ${ingredients.length} ingredients for ${recipe.meal}`);
                } else {
                    alert('Could not extract ingredients. Please check console for details.');
                }
            } catch (error) {
                alert('Failed to extract ingredients: ' + error.message);
            }
        }
        
        async function extractAllMissing() {
            const needsExtraction = weeklyMenu.filter(item => !item.ingredients && item.url);
            if (needsExtraction.length === 0) {
                alert('All recipes already have ingredients!');
                return;
            }
            
            if (!confirm(`Extract ingredients for ${needsExtraction.length} recipe(s)? This may take a moment.`)) {
                return;
            }
            
            await extractAllIngredients();
            await loadShoppingListFromMenu();
            render();
            alert('Ingredient extraction complete! Check the console for details.');
        }
        
        async function loadFullRecipe(url) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Loading recipe from Ollama...';
            btn.disabled = true;
            
            try {
                const fullRecipe = await fetchFullRecipeWithOllama(url);
                if (fullRecipe) {
                    recipeCache[url] = fullRecipe;
                    render();
                } else {
                    alert('Failed to load recipe. Make sure Ollama is running at ' + OLLAMA_URL);
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                alert('Error loading recipe: ' + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        function copyShoppingList() {
            const text = shoppingList.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('Shopping list copied to clipboard!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }
        
        // Initialize app
        init();
    </script>
</body>
</html>
