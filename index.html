<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Automation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8e0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 16px;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 28px;
            color: #1f2937;
        }
        
        .current-day {
            color: #6b7280;
            font-size: 14px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .nav-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: #6b7280;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .nav-tab:hover {
            background: #f3f4f6;
        }
        
        .nav-tab.active {
            background: #ea580c;
            color: white;
        }
        
        .recipe-card {
            border: 2px solid #fed7aa;
            border-radius: 12px;
            padding: 20px;
            background: #fff7ed;
            margin-bottom: 16px;
        }
        
        .recipe-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .recipe-subtitle {
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .recipe-link-box {
            background: #fff;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .recipe-link-box a {
            color: #ea580c;
            text-decoration: none;
            word-break: break-all;
        }
        
        .recipe-link-box a:hover {
            text-decoration: underline;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #ea580c;
            color: white;
        }
        
        .btn-primary:hover {
            background: #c2410c;
        }
        
        .btn-success {
            background: #16a34a;
            color: white;
        }
        
        .btn-success:hover {
            background: #15803d;
        }
        
        .week-item {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        
        .week-item:hover {
            border-color: #d1d5db;
        }
        
        .week-item.today {
            border-color: #fb923c;
            background: #fff7ed;
        }
        
        .week-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }
        
        .day-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .today-badge {
            display: inline-block;
            background: #ea580c;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .meal-name {
            font-size: 18px;
            font-weight: 500;
            color: #374151;
            margin: 8px 0;
        }
        
        .recipe-type {
            font-size: 14px;
            color: #6b7280;
        }
        
        .shopping-list {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
        }
        
        .shopping-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }
        
        .shopping-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .info-box {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Content will be injected here -->
    </div>

    <!-- Google API Libraries -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // Configuration - REPLACE THESE WITH YOUR OWN VALUES
        const SHEET_ID = '1b8VXiTPe4jMVBXLKdhSYLjas36QT0tfu3OBlMrdF_Q0';
        const API_KEY = 'AIzaSyBtIH1g9yZdjJ3lOtl7o7PmA9ukc76aTtE'; // Still used for read operations
        const OAUTH_CLIENT_ID = '582779635693-072h14eqgs6gch0ncvmocj9v7gn0k52f.apps.googleusercontent.com'; // Replace with your OAuth Client ID
        const BRIDGE_URL = 'http://localhost:5000'; // Python bridge server

        // OAuth variables
        let isSignedIn = false;
        let authInstance = null;
        
        // Demo data (fallback)
        const DEMO_MENU = [
            { day: 'Monday', meal: 'Spaghetti Carbonara', url: 'https://www.example.com/carbonara', type: 'written' },
            { day: 'Tuesday', meal: 'Chicken Stir Fry', url: 'https://youtube.com/watch?v=abc123', type: 'video' },
            { day: 'Wednesday', meal: 'Beef Tacos', url: 'https://www.example.com/tacos', type: 'written' },
            { day: 'Thursday', meal: 'Salmon with Rice', url: 'https://www.example.com/salmon', type: 'written' },
            { day: 'Friday', meal: 'Pizza Night', url: 'https://www.example.com/pizza', type: 'written' },
            { day: 'Saturday', meal: 'BBQ Ribs', url: 'https://youtube.com/watch?v=xyz789', type: 'video' },
            { day: 'Sunday', meal: 'Roast Chicken', url: 'https://www.example.com/roast', type: 'written' }
        ];
        
        // Removed demo shopping list - now simplified
        
        // State
        let currentView = 'today';
        let weeklyMenu = [];
        let savedRecipes = {}; // Dictionary for saving recipes
        let isConfigured = true; // Set to true to always try loading from sheet
        
        // Get current day
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        let currentDay = days[new Date().getDay()];
        
        // Check URL parameters for day override (useful for NFC)
        const urlParams = new URLSearchParams(window.location.search);
        const dayParam = urlParams.get('day');
        if (dayParam) {
            currentDay = dayParam;
        }
        
        // Initialize
        function init() {
            initGoogleAuth();
        }

        // Initialize Google OAuth
        function initGoogleAuth() {
            console.log('Initializing Google Auth...');

            // Initialize both APIs
            gapi.load('auth2:client', async () => {
                try {
                    // Initialize the auth2 library
                    await gapi.auth2.init({
                        client_id: OAUTH_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/spreadsheets'
                    });

                    // Initialize the client library
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                    });

                    authInstance = gapi.auth2.getAuthInstance();
                    isSignedIn = authInstance.isSignedIn.get();

                    console.log('Google Auth initialized. Signed in:', isSignedIn);

                    // Listen for sign-in state changes
                    authInstance.isSignedIn.listen(updateSigninStatus);

                    loadData();

                } catch (error) {
                    console.error('Error initializing Google Auth:', error);
                    loadData(); // Continue with localStorage only
                }
            });
        }

        // Handle sign-in state changes
        function updateSigninStatus(signedIn) {
            isSignedIn = signedIn;
            if (signedIn) {
                console.log('✓ Signed in to Google');
                // Reload saved recipes to sync with Google Sheets
                loadSavedRecipes();
            } else {
                console.log('⚠️ Signed out of Google');
            }
            render(); // Update UI
        }

        // Sign in to Google
        function signInToGoogle() {
            console.log('Attempting to sign in...');
            if (authInstance) {
                authInstance.signIn({
                    scope: 'https://www.googleapis.com/auth/spreadsheets'
                }).then(() => {
                    console.log('✓ Sign-in successful');
                }).catch(error => {
                    console.error('Sign-in error:', error);
                    alert('Failed to sign in to Google. Check console for details.');
                });
            } else {
                console.error('Auth instance not initialized');
                alert('Google Auth not ready. Please refresh the page.');
            }
        }

        // Sign out of Google
        function signOutOfGoogle() {
            console.log('Signing out...');
            if (authInstance) {
                authInstance.signOut();
            }
        }
        
        // Load data from Google Sheets
        function loadData() {
            loadFromGoogleSheets();
        }
        
        async function loadFromGoogleSheets() {
            const range = 'Weekly Menu!A2:D8'; // Only need day, meal, url, type
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (data.values) {
                    weeklyMenu = data.values.map((row, index) => ({
                        day: row[0] || '',
                        meal: row[1] || '',
                        url: row[2] || '',
                        type: row[3] || 'written',
                        rowIndex: index + 2 // Sheet row number (A2 = index 2)
                    })).filter(item => item.day && item.meal); // Filter out empty rows

                    console.log('Loaded menu:', weeklyMenu);

                    // Load saved recipes dictionary
                    await loadSavedRecipes();
                } else {
                    throw new Error('No data found in sheet');
                }

                render();
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                alert('Could not load recipes from Google Sheets. Using demo data.\n\nError: ' + error.message);
                // Fallback to demo data
                weeklyMenu = DEMO_MENU;
                render();
            }
        }
        
        async function loadSavedRecipes() {
            // First try to load from localStorage
            const localRecipes = localStorage.getItem('savedRecipes');
            if (localRecipes) {
                try {
                    savedRecipes = JSON.parse(localRecipes);
                    console.log('Loaded saved recipes from localStorage:', Object.keys(savedRecipes).length);
                } catch (error) {
                    console.error('Error parsing localStorage recipes:', error);
                }
            }

            // Then try to load from Google Sheets (if available)
            const range = 'Saved Recipes!A2:C100';
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.values) {
                    // Merge with existing recipes
                    data.values.forEach(row => {
                        if (row[0] && row[1]) { // name and url
                            savedRecipes[row[0]] = {
                                url: row[1],
                                type: row[2] || 'written'
                            };
                        }
                    });
                    console.log('Loaded saved recipes from Google Sheets:', Object.keys(savedRecipes).length);

                    // Save merged recipes to localStorage
                    localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
                }
            } catch (error) {
                console.log('Could not load from Saved Recipes sheet:', error.message);
                console.log('Using localStorage recipes only');
            }
        }
        
        
        async function saveRecipeToLibrary(name, url, type) {
            // Add recipe to saved recipes dictionary
            savedRecipes[name] = { url, type };

            // Always save to localStorage first (this will work reliably)
            try {
                localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
                console.log('✓ Recipe saved locally:', name);
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }

            // Save to Google Sheets if authenticated
            if (isSignedIn && authInstance) {
                try {
                    const request = {
                        spreadsheetId: SHEET_ID,
                        range: 'Saved Recipes!A:C',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [[name, url, type]]
                        }
                    };

                    const response = await gapi.client.sheets.spreadsheets.values.append(request);
                    console.log('✓ Recipe saved to Google Sheets:', name);
                } catch (error) {
                    console.error('Error saving to Google Sheets:', error);
                    console.log('⚠️ Could not save to Google Sheets, but saved locally');
                }
            } else {
                console.log('⚠️ Not signed in to Google - recipe saved locally only');
            }
        }

        // Get cooking.guru URL for video recipes
        function getCookingGuruUrl(url) {
            return `https://cooking.guru/?url=${encodeURIComponent(url)}`;
        }
        
        // Get today's recipe
        function getTodaysRecipe() {
            return weeklyMenu.find(item => item.day === currentDay);
        }
        
        // Render functions
        function renderTodayView() {
            const recipe = getTodaysRecipe();
            if (!recipe) {
                return `<div class="info-box">No recipe scheduled for ${currentDay}. Check your Google Sheet or view This Week tab.</div>`;
            }

            const isVideo = recipe.type === 'video';
            const recipeUrl = recipe.url;
            const cookingGuruUrl = isVideo ? getCookingGuruUrl(recipe.url) : null;

            return `
                <div class="recipe-card">
                    <h2 class="recipe-title">${recipe.meal}</h2>
                    <p class="recipe-subtitle">${recipe.day}'s Dinner</p>

                    ${isVideo ? `
                        <div class="info-box">
                            📹 This is a video recipe. Copy the URL below into cooking.guru to generate a written version.
                        </div>

                        <div class="recipe-link-box">
                            <strong>cooking.guru:</strong><br>
                            <a href="https://cooking.guru" target="_blank" rel="noopener noreferrer">
                                Open cooking.guru
                            </a>
                        </div>

                        <div class="recipe-link-box">
                            <strong>Original Video URL:</strong><br>
                            <input type="text" value="${recipeUrl}" readonly style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;" onclick="this.select()">
                        </div>
                    ` : `
                        <div class="recipe-link-box">
                            <strong>Recipe URL:</strong><br>
                            <a href="${recipeUrl}" target="_blank" rel="noopener noreferrer">
                                ${recipeUrl}
                            </a>
                        </div>
                    `}

                    <button class="btn btn-primary" onclick="window.open('${recipeUrl}', '_blank')" style="background: #16a34a;">
                        🔗 Open Original Recipe
                    </button>

                    <button class="btn btn-primary" onclick="saveCurrentRecipe()" style="background: #6366f1; margin-top: 8px;">
                        📾 Save Recipe to Library
                    </button>
                </div>
            `;
        }
        
        function renderWeekView() {
            if (weeklyMenu.length === 0) {
                return '<div class="info-box">No recipes loaded. Check your Google Sheet configuration.</div>';
            }

            const items = weeklyMenu.map((item, index) => {
                const isToday = item.day === currentDay;
                const isVideo = item.type === 'video';

                return `
                    <div class="week-item ${isToday ? 'today' : ''}">
                        <div class="week-item-header">
                            <div style="flex: 1;">
                                <div class="day-name">
                                    ${item.day}
                                    ${isToday ? '<span class="today-badge">Today</span>' : ''}
                                </div>
                                <div class="meal-name">${item.meal}</div>
                                <div class="recipe-type">
                                    ${isVideo ? '📹 Video Recipe' : '📄 Written Recipe'}
                                </div>

                                ${isVideo ? `
                                    <div style="margin-top: 8px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 12px;">
                                        Copy to cooking.guru: <input type="text" value="${item.url}" readonly onclick="this.select()" style="width: 200px; font-size: 10px; padding: 2px;">
                                    </div>
                                ` : ''}
                            </div>
                            <a href="${item.url}" target="_blank" rel="noopener noreferrer" style="color: #ea580c; text-decoration: none; font-size: 24px;">
                                🔗
                            </a>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
                    <h2 style="font-size: 24px; font-weight: bold; color: #1f2937;">This Week's Menu</h2>
                </div>
                <div class="info-box" style="font-size: 14px;">
                    <strong>Simplified View:</strong> URLs are shown directly. For video recipes, copy the URL into cooking.guru to generate written instructions.
                </div>
                ${items}
            `;
        }
        
        function renderShoppingView() {
            return `
                <h2 style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 16px;">Shopping List</h2>
                <div class="info-box">
                    🛒 Shopping list generation has been simplified. Create your own list from the recipe URLs or manually add ingredients to your Google Sheet for automatic generation in the future.
                </div>

                <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-top: 16px;">
                    <textarea placeholder="Add your shopping items here..." style="width: 100%; height: 200px; border: 1px solid #d1d5db; border-radius: 4px; padding: 8px; resize: vertical;"></textarea>
                </div>
            `;
        }
        
        function renderDictionaryView() {
            const savedRecipeItems = Object.keys(savedRecipes).map(name => {
                const recipe = savedRecipes[name];
                const isVideo = recipe.type === 'video';
                return `
                    <div class="week-item">
                        <div class="week-item-header">
                            <div style="flex: 1;">
                                <div class="meal-name">${name}</div>
                                <div class="recipe-type">
                                    ${isVideo ? '📹 Video Recipe' : '📄 Written Recipe'}
                                </div>
                                ${isVideo ? `
                                    <div style="margin-top: 8px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 12px;">
                                        Copy to cooking.guru: <input type="text" value="${recipe.url}" readonly onclick="this.select()" style="width: 200px; font-size: 10px; padding: 2px;">
                                    </div>
                                ` : ''}
                            </div>
                            <a href="${recipe.url}" target="_blank" rel="noopener noreferrer" style="color: #ea580c; text-decoration: none; font-size: 24px;">
                                🔗
                            </a>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="font-size: 24px; font-weight: bold; color: #1f2937;">Saved Recipes</h2>
                    <button class="btn btn-primary" onclick="showAddRecipeForm()" style="width: auto; padding: 10px 20px;">
                        ➕ Add Recipe
                    </button>
                </div>
                <p style="color: #6b7280; margin-bottom: 16px;">Your recipe collection for future weeks.</p>

                ${Object.keys(savedRecipes).length > 0 ? savedRecipeItems : '<div class="info-box">No saved recipes yet. Use the "Save Recipe to Library" button on today\'s view or add them manually here.</div>'}
            `;
        }
        
        function render() {
            const app = document.getElementById('app');
            
            const authStatus = isSignedIn ?
                `<span style="color: #16a34a;">✓ Google Sheets Connected</span>` :
                `<span style="color: #ea580c;">⚠️ Local Storage Only</span>`;

            let content = `
                <div class="card">
                    <div class="header">
                        <div>
                            <h1>🍳 Recipe Automation</h1>
                            <div class="current-day">${currentDay}</div>
                            <div style="font-size: 12px; margin-top: 4px;">${authStatus}</div>
                        </div>
                        <div>
                            ${!isSignedIn ?
                                `<button class="btn btn-primary" onclick="signInToGoogle()" style="padding: 8px 16px; font-size: 14px;">Sign in to Google</button>` :
                                `<button class="btn btn-primary" onclick="signOutOfGoogle()" style="padding: 8px 16px; font-size: 14px; background: #dc2626;">Sign Out</button>`
                            }
                        </div>
                    </div>
                </div>
                
                <div class="nav-tabs">
                    <button class="nav-tab ${currentView === 'today' ? 'active' : ''}" onclick="changeView('today')">
                        Today's Recipe
                    </button>
                    <button class="nav-tab ${currentView === 'week' ? 'active' : ''}" onclick="changeView('week')">
                        This Week
                    </button>
                    <button class="nav-tab ${currentView === 'dictionary' ? 'active' : ''}" onclick="changeView('dictionary')">
                        Saved Recipes
                    </button>
                </div>
                
                <div class="card">
            `;
            
            switch(currentView) {
                case 'today':
                    content += renderTodayView();
                    break;
                case 'week':
                    content += renderWeekView();
                    break;
                case 'shopping':
                    content += renderShoppingView();
                    break;
                case 'dictionary':
                    content += renderDictionaryView();
                    break;
            }
            
            content += '</div>';
            
            app.innerHTML = content;
        }
        
        // Event handlers
        function changeView(view) {
            currentView = view;
            render();
        }
        
        function showShopping() {
            currentView = 'shopping';
            render();
        }
        
        function saveCurrentRecipe() {
            const recipe = getTodaysRecipe();
            if (!recipe) return;

            const name = prompt('Enter a name for this recipe:', recipe.meal);
            if (name && name.trim()) {
                saveRecipeToLibrary(name.trim(), recipe.url, recipe.type);
                alert('✓ Recipe saved to library!');
            }
        }

        function showAddRecipeForm() {
            const name = prompt('Recipe name:');
            if (!name) return;

            const url = prompt('Recipe URL:');
            if (!url) return;

            const type = confirm('Is this a video recipe?') ? 'video' : 'written';

            saveRecipeToLibrary(name, url, type);
            render();
            alert('✓ Recipe added to library!');
        }
        
        // Initialize app
        init();
    </script>
</body>
</html>