<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Automation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8e0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 16px;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 28px;
            color: #1f2937;
        }
        
        .current-day {
            color: #6b7280;
            font-size: 14px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .nav-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: #6b7280;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .nav-tab:hover {
            background: #f3f4f6;
        }
        
        .nav-tab.active {
            background: #ea580c;
            color: white;
        }
        
        .recipe-card {
            border: 2px solid #fed7aa;
            border-radius: 12px;
            padding: 20px;
            background: #fff7ed;
            margin-bottom: 16px;
        }
        
        .recipe-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .recipe-subtitle {
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .recipe-link-box {
            background: #fff;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .recipe-link-box a {
            color: #ea580c;
            text-decoration: none;
            word-break: break-all;
        }
        
        .recipe-link-box a:hover {
            text-decoration: underline;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #ea580c;
            color: white;
        }
        
        .btn-primary:hover {
            background: #c2410c;
        }
        
        .btn-success {
            background: #16a34a;
            color: white;
        }
        
        .btn-success:hover {
            background: #15803d;
        }
        
        .week-item {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        
        .week-item:hover {
            border-color: #d1d5db;
        }
        
        .week-item.today {
            border-color: #fb923c;
            background: #fff7ed;
        }
        
        .week-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }
        
        .day-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .today-badge {
            display: inline-block;
            background: #ea580c;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .meal-name {
            font-size: 18px;
            font-weight: 500;
            color: #374151;
            margin: 8px 0;
        }
        
        .recipe-type {
            font-size: 14px;
            color: #6b7280;
        }
        
        .shopping-list {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
        }
        
        .shopping-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }
        
        .shopping-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .info-box {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Content will be injected here -->
    </div>

    <!-- Google API Libraries -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // Configuration - REPLACE THESE WITH YOUR OWN VALUES
        const SHEET_ID = '1b8VXiTPe4jMVBXLKdhSYLjas36QT0tfu3OBlMrdF_Q0';
        const API_KEY = 'AIzaSyBtIH1g9yZdjJ3lOtl7o7PmA9ukc76aTtE'; // Still used for read operations
        const OAUTH_CLIENT_ID = '582779635693-072h14eqgs6gch0ncvmocj9v7gn0k52f.apps.googleusercontent.com'; // Replace with your OAuth Client ID
        const BRIDGE_URL = 'http://localhost:5000'; // Python bridge server
        const RECIPE_SCRAPER_URL = 'http://localhost:5001/scrape'; // Recipe scraper endpoint

        // OAuth variables
        let isSignedIn = false;
        let accessToken = null;
        let tokenClient = null;
        
        // Demo data (fallback)
        const DEMO_MENU = [
            { day: 'Monday', meal: 'Spaghetti Carbonara', url: 'https://www.example.com/carbonara', type: 'written' },
            { day: 'Tuesday', meal: 'Chicken Stir Fry', url: 'https://youtube.com/watch?v=abc123', type: 'video' },
            { day: 'Wednesday', meal: 'Beef Tacos', url: 'https://www.example.com/tacos', type: 'written' },
            { day: 'Thursday', meal: 'Salmon with Rice', url: 'https://www.example.com/salmon', type: 'written' },
            { day: 'Friday', meal: 'Pizza Night', url: 'https://www.example.com/pizza', type: 'written' },
            { day: 'Saturday', meal: 'BBQ Ribs', url: 'https://youtube.com/watch?v=xyz789', type: 'video' },
            { day: 'Sunday', meal: 'Roast Chicken', url: 'https://www.example.com/roast', type: 'written' }
        ];
        
        // Removed demo shopping list - now simplified
        
        // State
        let currentView = 'today';
        let weeklyMenu = [];
        let savedRecipes = {}; // Dictionary for saving recipes
        let isConfigured = true; // Set to true to always try loading from sheet
        
        // Get current day
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        let currentDay = days[new Date().getDay()];
        
        // Check URL parameters for day override (useful for NFC)
        const urlParams = new URLSearchParams(window.location.search);
        const dayParam = urlParams.get('day');
        if (dayParam) {
            currentDay = dayParam;
        }
        
        // Initialize
        function init() {
            initGoogleAuth();
        }

        // Initialize Google Auth using new Google Identity Services
        function initGoogleAuth() {
            console.log('Initializing Google Auth...');

            // Wait for Google APIs to load
            const initializeApis = () => {
                try {
                    // Initialize the Google API client
                    gapi.load('client', async () => {
                        try {
                            await gapi.client.init({
                                apiKey: API_KEY,
                                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                            });
                            console.log('Google API client initialized');
                        } catch (error) {
                            console.error('Error initializing Google client:', error);
                        }
                    });

                    // Initialize the OAuth2 token client (newer API)
                    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                        tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: OAUTH_CLIENT_ID,
                            scope: 'https://www.googleapis.com/auth/spreadsheets',
                            callback: (tokenResponse) => {
                                console.log('‚úì Token received:', tokenResponse);
                                if (tokenResponse.access_token) {
                                    accessToken = tokenResponse.access_token;
                                    isSignedIn = true;
                                    updateSigninStatus(true);
                                }
                            }
                        });
                        console.log('Token client initialized');
                    } else {
                        console.log('Google Identity Services not yet loaded, will retry...');
                        setTimeout(initializeApis, 500);
                        return;
                    }

                    // Try to load any saved access token
                    loadSavedToken();
                    loadData();

                } catch (error) {
                    console.error('Error initializing Google Auth:', error);
                    // Try to load any saved access token
                    loadSavedToken();
                    loadData(); // Continue with localStorage only
                }
            };

            // Start initialization
            initializeApis();
        }

        // Handle sign-in state changes
        function updateSigninStatus(signedIn) {
            isSignedIn = signedIn;
            if (signedIn) {
                console.log('‚úì Signed in to Google');
                // Reload saved recipes to sync with Google Sheets
                loadSavedRecipes();
            } else {
                console.log('‚ö†Ô∏è Signed out of Google');
                accessToken = null;
            }
            render(); // Update UI
        }

        // Sign in to Google
        function signInToGoogle() {
            console.log('Attempting to sign in...');
            if (tokenClient) {
                try {
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } catch (error) {
                    console.error('Sign-in error:', error);
                    showManualAuthOption();
                }
            } else {
                console.error('Token client not initialized');
                showManualAuthOption();
            }
        }

        // Show manual auth option when OAuth fails
        function showManualAuthOption() {
            const useManual = confirm(
                'OAuth popup failed due to browser security restrictions.\n\n' +
                'Would you like to use manual authentication instead?\n' +
                '(This involves copying a token from Google manually)'
            );

            if (useManual) {
                showManualAuthInstructions();
            }
        }

        // Show manual authentication instructions
        function showManualAuthInstructions() {
            const instructions = `
Manual Google Sheets Authentication:

1. Open this URL in a new tab:
https://accounts.google.com/oauth/authorize?client_id=${OAUTH_CLIENT_ID}&redirect_uri=urn:ietf:wg:oauth:2.0:oob&scope=https://www.googleapis.com/auth/spreadsheets&response_type=code

2. Sign in and grant permissions
3. Copy the authorization code that appears
4. Paste it in the prompt that follows

Click OK to continue...`;

            alert(instructions);

            const authCode = prompt('Paste the authorization code here:');
            if (authCode && authCode.trim()) {
                exchangeCodeForToken(authCode.trim());
            }
        }

        // Exchange authorization code for access token
        async function exchangeCodeForToken(authCode) {
            try {
                const response = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        code: authCode,
                        client_id: OAUTH_CLIENT_ID,
                        client_secret: '', // This won't work without client secret
                        redirect_uri: 'urn:ietf:wg:oauth:2.0:oob',
                        grant_type: 'authorization_code'
                    })
                });

                if (response.ok) {
                    const tokenData = await response.json();
                    accessToken = tokenData.access_token;
                    isSignedIn = true;
                    updateSigninStatus(true);
                    console.log('‚úì Manual authentication successful');
                } else {
                    console.error('Token exchange failed:', await response.text());
                    showSimpleTokenEntry();
                }
            } catch (error) {
                console.error('Error exchanging code for token:', error);
                showSimpleTokenEntry();
            }
        }

        // Simple token entry (requires user to get token manually)
        function showSimpleTokenEntry() {
            const instructions = `
The automatic token exchange failed. You can get a token manually:

1. Go to: https://developers.google.com/oauthplayground/
2. Click the gear icon (‚öôÔ∏è) in top right
3. Check "Use your own OAuth credentials"
4. Enter your Client ID: ${OAUTH_CLIENT_ID}
5. In "Step 1", find "Google Sheets API v4" and check:
   - https://www.googleapis.com/auth/spreadsheets
6. Click "Authorize APIs"
7. Click "Exchange authorization code for tokens"
8. Copy the "Access token" that appears

Click OK then paste the access token...`;

            alert(instructions);

            const token = prompt('Paste the access token here:');
            if (token && token.trim()) {
                accessToken = token.trim();
                isSignedIn = true;
                updateSigninStatus(true);
                console.log('‚úì Manual token entry successful');

                // Save token to localStorage for future use
                localStorage.setItem('googleAccessToken', accessToken);
            }
        }

        // Try to load saved access token
        function loadSavedToken() {
            const savedToken = localStorage.getItem('googleAccessToken');
            if (savedToken) {
                console.log('Found saved access token, testing...');
                accessToken = savedToken;
                isSignedIn = true;
                updateSigninStatus(true);
            }
        }

        // Sign out of Google
        function signOutOfGoogle() {
            console.log('Signing out...');
            if (accessToken && typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                try {
                    google.accounts.oauth2.revoke(accessToken, () => {
                        console.log('Access token revoked');
                    });
                } catch (error) {
                    console.log('Could not revoke token via API:', error);
                }
            }

            // Clear local storage and state
            localStorage.removeItem('googleAccessToken');
            accessToken = null;
            isSignedIn = false;
            updateSigninStatus(false);
        }
        
        // Load data from Google Sheets
        function loadData() {
            loadFromGoogleSheets();
        }
        
        async function loadFromGoogleSheets() {
            const range = 'Weekly Menu!A2:E8'; // Include ingredients column (E)
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (data.values) {
                    weeklyMenu = data.values.map((row, index) => ({
                        day: row[0] || '',
                        meal: row[1] || '',
                        url: row[2] || '',
                        type: row[3] || 'written',
                        ingredients: row[4] || '', // Ingredients from column E
                        rowIndex: index + 2 // Sheet row number (A2 = index 2)
                    })).filter(item => item.day && item.meal); // Filter out empty rows

                    console.log('Loaded menu:', weeklyMenu);

                    // Load saved recipes dictionary
                    await loadSavedRecipes();

                    // Auto-scrape ingredients for recipes that don't have them
                    await autoScrapeAllIngredients();
                } else {
                    throw new Error('No data found in sheet');
                }

                render();
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                alert('Could not load recipes from Google Sheets. Using demo data.\n\nError: ' + error.message);
                // Fallback to demo data
                weeklyMenu = DEMO_MENU;
                render();
            }
        }
        
        async function loadSavedRecipes() {
            // First try to load from localStorage
            const localRecipes = localStorage.getItem('savedRecipes');
            if (localRecipes) {
                try {
                    savedRecipes = JSON.parse(localRecipes);
                    console.log('Loaded saved recipes from localStorage:', Object.keys(savedRecipes).length);
                } catch (error) {
                    console.error('Error parsing localStorage recipes:', error);
                }
            }

            // Then try to load from Google Sheets (if available)
            const range = 'Saved Recipes!A2:D100'; // Include ingredients column
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.values) {
                    // Merge with existing recipes
                    data.values.forEach(row => {
                        if (row[0] && row[1]) { // name and url
                            savedRecipes[row[0]] = {
                                url: row[1],
                                type: row[2] || 'written',
                                ingredients: row[3] || ''
                            };
                        }
                    });
                    console.log('Loaded saved recipes from Google Sheets:', Object.keys(savedRecipes).length);

                    // Save merged recipes to localStorage
                    localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
                }
            } catch (error) {
                console.log('Could not load from Saved Recipes sheet:', error.message);
                console.log('Using localStorage recipes only');
            }
        }
        

        // Auto-scrape ingredients for all recipes that don't have them
        async function autoScrapeAllIngredients() {
            if (!isSignedIn) {
                console.log('Not signed in - skipping auto-scrape');
                return;
            }

            const recipesToScrape = weeklyMenu.filter(recipe =>
                recipe.type === 'written' && !recipe.ingredients && recipe.url
            );

            if (recipesToScrape.length === 0) {
                console.log('No recipes need ingredient scraping');
                return;
            }

            console.log(`Auto-scraping ingredients for ${recipesToScrape.length} recipes...`);

            // Show notification
            showScrapingNotification(recipesToScrape.length);

            let scrapedCount = 0;

            // Scrape recipes sequentially to avoid overwhelming the server
            for (const recipe of recipesToScrape) {
                try {
                    console.log(`Scraping: ${recipe.meal}`);
                    updateScrapingNotification(scrapedCount + 1, recipesToScrape.length, recipe.meal);

                    const ingredients = await scrapeRecipeIngredients(recipe.url);

                    if (ingredients) {
                        // Update in sheet
                        const success = await updateIngredientsInSheet(recipe.rowIndex, ingredients);

                        if (success) {
                            recipe.ingredients = ingredients;
                            console.log(`‚úì Updated ingredients for ${recipe.meal}`);
                            scrapedCount++;
                        }
                    }

                    // Small delay to be polite to the scraper service
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error(`Error scraping ${recipe.meal}:`, error);
                }
            }

            console.log('Auto-scraping complete');
            hideScrapingNotification();

            if (scrapedCount > 0) {
                showTemporaryMessage(`‚úì Successfully scraped ingredients for ${scrapedCount} recipe${scrapedCount > 1 ? 's' : ''}!`);
            }

            render(); // Update UI with new ingredients
        }

        // Show scraping notification
        function showScrapingNotification(total) {
            const notification = document.createElement('div');
            notification.id = 'scraping-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fef3c7;
                border: 2px solid #f59e0b;
                border-radius: 12px;
                padding: 16px 20px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                min-width: 300px;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">ü•ï</div>
                    <div>
                        <div style="font-weight: 600; color: #92400e;">Scraping Ingredients...</div>
                        <div id="scraping-status" style="color: #78350f; font-size: 14px; margin-top: 4px;">
                            Starting...
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
        }

        function updateScrapingNotification(current, total, recipeName) {
            const status = document.getElementById('scraping-status');
            if (status) {
                status.textContent = `${current} of ${total}: ${recipeName}`;
            }
        }

        function hideScrapingNotification() {
            const notification = document.getElementById('scraping-notification');
            if (notification) {
                notification.style.transition = 'opacity 0.3s';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }
        }

        function showTemporaryMessage(message) {
            const msg = document.createElement('div');
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d1fae5;
                border: 2px solid #10b981;
                border-radius: 12px;
                padding: 16px 20px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                font-weight: 500;
                color: #065f46;
            `;
            msg.textContent = message;
            document.body.appendChild(msg);

            setTimeout(() => {
                msg.style.transition = 'opacity 0.3s';
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 300);
            }, 3000);
        }

        // Scrape recipe ingredients
        async function scrapeRecipeIngredients(url) {
            try {
                console.log('Scraping ingredients from:', url);
                const response = await fetch(RECIPE_SCRAPER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    throw new Error(`Scraper returned ${response.status}`);
                }

                const data = await response.json();
                if (data.ingredients && data.ingredients.length > 0) {
                    return data.ingredients.join(', ');
                } else {
                    console.log('No ingredients found');
                    return '';
                }
            } catch (error) {
                console.error('Error scraping recipe:', error);
                return '';
            }
        }

        // Update ingredients in Google Sheet
        async function updateIngredientsInSheet(rowIndex, ingredients) {
            if (!isSignedIn || !accessToken) {
                console.log('Not signed in - cannot update sheet');
                return false;
            }

            try {
                gapi.client.setToken({
                    access_token: accessToken
                });

                const range = `Weekly Menu!E${rowIndex}`; // Column E (ingredients)
                const request = {
                    spreadsheetId: SHEET_ID,
                    range: range,
                    valueInputOption: 'RAW',
                    resource: {
                        values: [[ingredients]]
                    }
                };

                await gapi.client.sheets.spreadsheets.values.update(request);
                console.log('‚úì Ingredients updated in sheet at row', rowIndex);
                return true;
            } catch (error) {
                console.error('Error updating sheet:', error);
                if (error.status === 401) {
                    signOutOfGoogle();
                }
                return false;
            }
        }

        async function saveRecipeToLibrary(name, url, type, ingredients = '') {
            // Scrape ingredients if not provided and it's a written recipe
            if (!ingredients && type === 'written') {
                const scraped = await scrapeRecipeIngredients(url);
                if (scraped) {
                    ingredients = scraped;
                    console.log('‚úì Ingredients scraped:', ingredients);
                }
            }

            // Add recipe to saved recipes dictionary
            savedRecipes[name] = { url, type, ingredients };

            // Always save to localStorage first (this will work reliably)
            try {
                localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
                console.log('‚úì Recipe saved locally:', name);
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }

            // Save to Google Sheets if authenticated
            if (isSignedIn && accessToken) {
                try {
                    // Set the access token for the API client
                    gapi.client.setToken({
                        access_token: accessToken
                    });

                    const request = {
                        spreadsheetId: SHEET_ID,
                        range: 'Saved Recipes!A:D',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [[name, url, type, ingredients]]
                        }
                    };

                    const response = await gapi.client.sheets.spreadsheets.values.append(request);
                    console.log('‚úì Recipe saved to Google Sheets:', name);
                } catch (error) {
                    console.error('Error saving to Google Sheets:', error);
                    console.log('‚ö†Ô∏è Could not save to Google Sheets, but saved locally');

                    // If token expired, sign out
                    if (error.status === 401) {
                        console.log('Access token expired, signing out');
                        signOutOfGoogle();
                    }
                }
            } else {
                console.log('‚ö†Ô∏è Not signed in to Google - recipe saved locally only');
            }

            return ingredients;
        }

        // Get cooking.guru URL for video recipes
        function getCookingGuruUrl(url) {
            return `https://cooking.guru/?url=${encodeURIComponent(url)}`;
        }
        
        // Get today's recipe
        function getTodaysRecipe() {
            return weeklyMenu.find(item => item.day === currentDay);
        }
        
        // Render functions
        function renderTodayView() {
            const recipe = getTodaysRecipe();
            if (!recipe) {
                return `<div class="info-box">No recipe scheduled for ${currentDay}. Check your Google Sheet or view This Week tab.</div>`;
            }

            const isVideo = recipe.type === 'video';
            const recipeUrl = recipe.url;
            const cookingGuruUrl = isVideo ? getCookingGuruUrl(recipe.url) : null;

            return `
                <div class="recipe-card">
                    <h2 class="recipe-title">${recipe.meal}</h2>
                    <p class="recipe-subtitle">${recipe.day}'s Dinner</p>

                    ${isVideo ? `
                        <div class="info-box">
                            üìπ This is a video recipe. Copy the URL below into cooking.guru to generate a written version.
                        </div>

                        <div class="recipe-link-box">
                            <strong>cooking.guru:</strong><br>
                            <a href="https://cooking.guru" target="_blank" rel="noopener noreferrer">
                                Open cooking.guru
                            </a>
                        </div>

                        <div class="recipe-link-box">
                            <strong>Original Video URL:</strong><br>
                            <input type="text" value="${recipeUrl}" readonly style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;" onclick="this.select()">
                        </div>
                    ` : `
                        <div class="recipe-link-box">
                            <strong>Recipe URL:</strong><br>
                            <a href="${recipeUrl}" target="_blank" rel="noopener noreferrer">
                                ${recipeUrl}
                            </a>
                        </div>
                    `}

                    <button class="btn btn-primary" onclick="window.open('${recipeUrl}', '_blank')" style="background: #16a34a;">
                        üîó Open Original Recipe
                    </button>

                    <button class="btn btn-primary" onclick="saveCurrentRecipe()" style="background: #6366f1; margin-top: 8px;">
                        üìæ Save Recipe to Library
                    </button>

                    ${!isVideo && !recipe.ingredients ? `
                        <button class="btn btn-primary" onclick="scrapeAndAddIngredients()" style="background: #8b5cf6; margin-top: 8px;">
                            ü•ï Scrape & Add Ingredients
                        </button>
                    ` : ''}

                    ${recipe.ingredients ? `
                        <div style="margin-top: 16px; padding: 12px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px;">
                            <strong>Ingredients:</strong><br>
                            <div style="margin-top: 8px; color: #15803d;">${recipe.ingredients}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function renderWeekView() {
            if (weeklyMenu.length === 0) {
                return '<div class="info-box">No recipes loaded. Check your Google Sheet configuration.</div>';
            }

            const items = weeklyMenu.map((item, index) => {
                const isToday = item.day === currentDay;
                const isVideo = item.type === 'video';

                return `
                    <div class="week-item ${isToday ? 'today' : ''}">
                        <div class="week-item-header">
                            <div style="flex: 1;">
                                <div class="day-name">
                                    ${item.day}
                                    ${isToday ? '<span class="today-badge">Today</span>' : ''}
                                </div>
                                <div class="meal-name">${item.meal}</div>
                                <div class="recipe-type">
                                    ${isVideo ? 'üìπ Video Recipe' : 'üìÑ Written Recipe'}
                                </div>

                                ${isVideo ? `
                                    <div style="margin-top: 8px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 12px;">
                                        Copy to cooking.guru: <input type="text" value="${item.url}" readonly onclick="this.select()" style="width: 200px; font-size: 10px; padding: 2px;">
                                    </div>
                                ` : ''}
                            </div>
                            <a href="${item.url}" target="_blank" rel="noopener noreferrer" style="color: #ea580c; text-decoration: none; font-size: 24px;">
                                üîó
                            </a>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
                    <h2 style="font-size: 24px; font-weight: bold; color: #1f2937;">This Week's Menu</h2>
                </div>
                <div class="info-box" style="font-size: 14px;">
                    <strong>Simplified View:</strong> URLs are shown directly. For video recipes, copy the URL into cooking.guru to generate written instructions.
                </div>
                ${items}
            `;
        }
        
        function renderShoppingView() {
            return `
                <h2 style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 16px;">Shopping List</h2>
                <div class="info-box">
                    üõí Shopping list generation has been simplified. Create your own list from the recipe URLs or manually add ingredients to your Google Sheet for automatic generation in the future.
                </div>

                <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-top: 16px;">
                    <textarea placeholder="Add your shopping items here..." style="width: 100%; height: 200px; border: 1px solid #d1d5db; border-radius: 4px; padding: 8px; resize: vertical;"></textarea>
                </div>
            `;
        }
        
        function renderDictionaryView() {
            const savedRecipeItems = Object.keys(savedRecipes).map(name => {
                const recipe = savedRecipes[name];
                const isVideo = recipe.type === 'video';
                return `
                    <div class="week-item">
                        <div class="week-item-header">
                            <div style="flex: 1;">
                                <div class="meal-name">${name}</div>
                                <div class="recipe-type">
                                    ${isVideo ? 'üìπ Video Recipe' : 'üìÑ Written Recipe'}
                                </div>
                                ${isVideo ? `
                                    <div style="margin-top: 8px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 12px;">
                                        Copy to cooking.guru: <input type="text" value="${recipe.url}" readonly onclick="this.select()" style="width: 200px; font-size: 10px; padding: 2px;">
                                    </div>
                                ` : ''}
                            </div>
                            <a href="${recipe.url}" target="_blank" rel="noopener noreferrer" style="color: #ea580c; text-decoration: none; font-size: 24px;">
                                üîó
                            </a>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="font-size: 24px; font-weight: bold; color: #1f2937;">Saved Recipes</h2>
                    <button class="btn btn-primary" onclick="showAddRecipeForm()" style="width: auto; padding: 10px 20px;">
                        ‚ûï Add Recipe
                    </button>
                </div>
                <p style="color: #6b7280; margin-bottom: 16px;">Your recipe collection for future weeks.</p>

                ${Object.keys(savedRecipes).length > 0 ? savedRecipeItems : '<div class="info-box">No saved recipes yet. Use the "Save Recipe to Library" button on today\'s view or add them manually here.</div>'}
            `;
        }
        
        function render() {
            const app = document.getElementById('app');
            
            const authStatus = isSignedIn ?
                `<span style="color: #16a34a;">‚úì Google Sheets Connected</span>` :
                `<span style="color: #ea580c;">‚ö†Ô∏è Local Storage Only</span>`;

            let content = `
                <div class="card">
                    <div class="header">
                        <div>
                            <h1>üç≥ Recipe Automation</h1>
                            <div class="current-day">${currentDay}</div>
                            <div style="font-size: 12px; margin-top: 4px;">${authStatus}</div>
                        </div>
                        <div>
                            ${!isSignedIn ?
                                `<button class="btn btn-primary" onclick="signInToGoogle()" style="padding: 8px 16px; font-size: 14px;">Sign in to Google</button>` :
                                `<button class="btn btn-primary" onclick="signOutOfGoogle()" style="padding: 8px 16px; font-size: 14px; background: #dc2626;">Sign Out</button>`
                            }
                        </div>
                    </div>
                </div>
                
                <div class="nav-tabs">
                    <button class="nav-tab ${currentView === 'today' ? 'active' : ''}" onclick="changeView('today')">
                        Today's Recipe
                    </button>
                    <button class="nav-tab ${currentView === 'week' ? 'active' : ''}" onclick="changeView('week')">
                        This Week
                    </button>
                    <button class="nav-tab ${currentView === 'dictionary' ? 'active' : ''}" onclick="changeView('dictionary')">
                        Saved Recipes
                    </button>
                </div>
                
                <div class="card">
            `;
            
            switch(currentView) {
                case 'today':
                    content += renderTodayView();
                    break;
                case 'week':
                    content += renderWeekView();
                    break;
                case 'shopping':
                    content += renderShoppingView();
                    break;
                case 'dictionary':
                    content += renderDictionaryView();
                    break;
            }
            
            content += '</div>';
            
            app.innerHTML = content;
        }
        
        // Event handlers
        function changeView(view) {
            currentView = view;
            render();
        }
        
        function showShopping() {
            currentView = 'shopping';
            render();
        }
        
        async function saveCurrentRecipe() {
            const recipe = getTodaysRecipe();
            if (!recipe) return;

            const name = prompt('Enter a name for this recipe:', recipe.meal);
            if (name && name.trim()) {
                const ingredients = await saveRecipeToLibrary(name.trim(), recipe.url, recipe.type, recipe.ingredients);
                if (ingredients) {
                    alert('‚úì Recipe saved to library with ingredients!');
                } else {
                    alert('‚úì Recipe saved to library!');
                }
            }
        }

        async function scrapeAndAddIngredients() {
            const recipe = getTodaysRecipe();
            if (!recipe || recipe.type === 'video') {
                alert('Can only scrape ingredients from written recipes');
                return;
            }

            if (!isSignedIn) {
                alert('Please sign in to Google to update the sheet with ingredients');
                return;
            }

            const confirmScrape = confirm(`Scrape ingredients for "${recipe.meal}"?\n\nThis will fetch ingredients from the recipe URL and add them to your Google Sheet.`);
            if (!confirmScrape) return;

            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Scraping...';

            try {
                // Scrape ingredients
                const ingredients = await scrapeRecipeIngredients(recipe.url);

                if (!ingredients) {
                    alert('Could not scrape ingredients from this recipe. The site may not be supported.');
                    return;
                }

                // Update in sheet
                const success = await updateIngredientsInSheet(recipe.rowIndex, ingredients);

                if (success) {
                    // Update local data
                    recipe.ingredients = ingredients;
                    render();
                    alert('‚úì Ingredients added successfully!');
                } else {
                    alert('‚ö†Ô∏è Ingredients scraped but could not update sheet. Please check your Google sign-in.');
                }
            } catch (error) {
                console.error('Error in scrapeAndAddIngredients:', error);
                alert('Error scraping ingredients: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function showAddRecipeForm() {
            const name = prompt('Recipe name:');
            if (!name) return;

            const url = prompt('Recipe URL:');
            if (!url) return;

            const type = confirm('Is this a video recipe?') ? 'video' : 'written';

            await saveRecipeToLibrary(name, url, type);
            render();
            alert('‚úì Recipe added to library!');
        }
        
        // Initialize app
        init();
    </script>
</body>
</html>